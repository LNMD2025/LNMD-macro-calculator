<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNMD Macro Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">LNMD Macro Calculator</h1>
        <div class="space-y-4">
            <div>
                <label for="wakeTime" class="block text-sm font-medium text-gray-700">Wake Time (24-hour format)</label>
                <select id="wakeTime" class="mt-1 block w-full p-2 border rounded-md" required>
                    <option value="">Select hour</option>
                </select>
            </div>
            <div>
                <label for="sleepTime" class="block text-sm font-medium text-gray-700">Sleep Time (24-hour format)</label>
                <select id="sleepTime" class="mt-1 block w-full p-2 border rounded-md" required>
                    <option value="">Select hour</option>
                </select>
            </div>
            <div>
                <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                <input type="number" id="weight" class="mt-1 block w-full p-2 border rounded-md" placeholder="Enter your weight" required>
            </div>
            <div>
                <label for="bodyFat" class="block text-sm font-medium text-gray-700">Body Fat Percentage (%)</label>
                <input type="number" id="bodyFat" min="0" max="100" class="mt-1 block w-full p-2 border rounded-md" placeholder="Enter body fat %" required>
            </div>
            <div>
                <label for="steps" class="block text-sm font-medium text-gray-700">Daily Steps (1000-10000)</label>
                <input type="number" id="steps" min="1000" max="10000" class="mt-1 block w-full p-2 border rounded-md" placeholder="Enter daily steps" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Exercise Hours per Week (1-40)</label>
                <div id="trainingTypes" class="space-y-2">
                    <div class="flex items-center space-x-2">
                        <select class="trainingType w-2/3 p-2 border rounded-md">
                            <option value="0">Select Training Type</option>
                            <option value="3">Yoga/Pilates (MET: 3)</option>
                            <option value="4.5">Weightlifting (MET: 4.5)</option>
                            <option value="7">Cycling (MET: 7)</option>
                            <option value="8">Swimming (MET: 8)</option>
                            <option value="9">Running (MET: 9)</option>
                            <option value="10">HIIT/Crossfit (MET: 10)</option>
                        </select>
                        <input type="number" class="trainingHours w-1/3 p-2 border rounded-md" min="0" max="40" placeholder="Hours" required>
                    </div>
                </div>
                <button onclick="addTrainingType()" class="mt-2 text-blue-600 hover:underline">+ Add Another Training Type</button>
            </div>
            <div>
                <label for="sessionsPerDay" class="block text-sm font-medium text-gray-700">Training Sessions per Day (1-3)</label>
                <select id="sessionsPerDay" class="mt-1 block w-full p-2 border rounded-md" onchange="updateSessionTimes()">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
            </div>
            <div id="sessionTimes" class="space-y-2">
                <!-- Session time selectors will be added here dynamically -->
            </div>
            <div>
                <label for="macroGoal" class="block text-sm font-medium text-gray-700">Macro Goal</label>
                <select id="macroGoal" class="mt-1 block w-full p-2 border rounded-md">
                    <option value="maintain">Maintain Weight</option>
                    <option value="recomp">Body Recomposition</option>
                    <option value="moderateCut">Moderate Weight Loss</option>
                    <option value="aggressiveCut">Aggressive Weight Loss</option>
                    <option value="aggressiveBulk">Aggressive Weight Gain</option>
                    <option value="performance">Athletic Performance</option>
                </select>
            </div>
            <div>
                <label for="proteinLevel" class="block text-sm font-medium text-gray-700">Protein Level (per kg total weight)</label>
                <select id="proteinLevel" class="mt-1 block w-full p-2 border rounded-md">
                    <option value="0.8">Low (0.8g/kg)</option>
                    <option value="1.5">Moderate (1.5g/kg)</option>
                    <option value="2.2">High (2.2g/kg)</option>
                </select>
            </div>
            <div>
                <label for="fatLevel" class="block text-sm font-medium text-gray-700">Fat Level (per kg lean mass)</label>
                <select id="fatLevel" class="mt-1 block w-full p-2 border rounded-md">
                    <option value="0.8">Low (0.8g/kg)</option>
                    <option value="1.4">Moderate (1.4g/kg)</option>
                    <option value="2.0">High (2.0g/kg)</option>
                </select>
            </div>
            <button onclick="calculateMacros()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Calculate</button>
        </div>
        <div id="results" class="mt-6 hidden">
            <h2 class="text-lg font-semibold">Your Daily Macros</h2>
            <p id="calories" class="text-gray-700"></p>
            <p id="protein" class="text-gray-700"></p>
            <p id="carbs" class="text-gray-700"></p>
            <p id="fats" class="text-gray-700"></p>
            <h2 class="text-lg font-semibold mt-4">Calculation Breakdown</h2>
            <p id="breakdown" class="text-gray-700"></p>
            <h2 class="text-lg font-semibold mt-4">Macro Partitioning Timeline</h2>
            <div id="partitioning" class="text-gray-700"></div>
            <h2 class="text-lg font-semibold mt-4">Meal Planner (Beta)</h2>
            <div id="mealPlanner" class="text-gray-700"></div>
        </div>
    </div>

    <script>
        function populateHourDropdown(selectElement) {
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i.toString().padStart(2, '0')}:00`;
                selectElement.appendChild(option);
            }
        }

        const wakeSelect = document.getElementById('wakeTime');
        const sleepSelect = document.getElementById('sleepTime');
        populateHourDropdown(wakeSelect);
        populateHourDropdown(sleepSelect);

        function addTrainingType() {
            const container = document.getElementById('trainingTypes');
            const newTrainingDiv = document.createElement('div');
            newTrainingDiv.classList.add('flex', 'items-center', 'space-x-2');
            newTrainingDiv.innerHTML = `
                <select class="trainingType w-2/3 p-2 border rounded-md">
                    <option value="0">Select Training Type</option>
                    <option value="3">Yoga/Pilates (MET: 3)</option>
                    <option value="4.5">Weightlifting (MET: 4.5)</option>
                    <option value="7">Cycling (MET: 7)</option>
                    <option value="8">Swimming (MET: 8)</option>
                    <option value="9">Running (MET: 9)</option>
                    <option value="10">HIIT/Crossfit (MET: 10)</option>
                </select>
                <input type="number" class="trainingHours w-1/3 p-2 border rounded-md" min="0" max="40" placeholder="Hours" required>
            `;
            container.appendChild(newTrainingDiv);
        }

        function updateSessionTimes() {
            const sessions = parseInt(document.getElementById('sessionsPerDay').value);
            const container = document.getElementById('sessionTimes');
            container.innerHTML = '';
            for (let i = 1; i <= sessions; i++) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="sessionTime${i}" class="block text-sm font-medium text-gray-700">Session ${i} Start Hour (24-hour format)</label>
                    <select id="sessionTime${i}" class="mt-1 block w-full p-2 border rounded-md" required>
                        <option value="">Select hour</option>
                    </select>
                `;
                container.appendChild(div);
                populateHourDropdown(document.getElementById(`sessionTime${i}`));
            }
        }

        // Initialize with 1 session
        updateSessionTimes();

        function formatTime(hour) {
            const ampm = hour >= 12 ? 'pm' : 'am';
            const h = hour % 12 || 12;
            return h + ampm;
        }

        function calculateMacros() {
            const wakeTime = parseInt(document.getElementById('wakeTime').value);
            const sleepTime = parseInt(document.getElementById('sleepTime').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const bodyFat = parseFloat(document.getElementById('bodyFat').value);
            const steps = parseFloat(document.getElementById('steps').value);
            const macroGoal = document.getElementById('macroGoal').value;
            const proteinPerKg = parseFloat(document.getElementById('proteinLevel').value);
            const fatPerKg = parseFloat(document.getElementById('fatLevel').value);
            const sessionsPerDay = parseInt(document.getElementById('sessionsPerDay').value);

            // Collect session times (now hours)
            const sessionTimes = [];
            for (let i = 1; i <= sessionsPerDay; i++) {
                sessionTimes.push(parseInt(document.getElementById(`sessionTime${i}`).value));
            }

            // Input validation
            if (isNaN(wakeTime) || isNaN(sleepTime) || !weight || !bodyFat || !steps || weight <= 0 || bodyFat < 0 || bodyFat > 100 || steps < 1000 || steps > 10000 || sessionTimes.some(isNaN)) {
                alert('Please enter valid inputs.');
                return;
            }

            // Adjust for sleep across midnight if needed
            let activeHours = sleepTime - wakeTime;
            if (activeHours < 0) activeHours += 24;

            // (Existing LBM, training data, BMR, TDEE, calorie adjustment, macro calculations)

            // Macro partitioning timeline
            const partitioningDiv = document.getElementById('partitioning');
            partitioningDiv.innerHTML = '';

            // Events for workouts
            const events = [];
            sessionTimes.forEach((startHour, index) => {
                const sessionNum = index + 1;

                events.push({
                    hour: startHour - 1 < wakeTime ? startHour - 1 + 24 : startHour - 1,
                    label: `${formatTime(startHour - 1)} - Pre-workout (Session ${sessionNum})`,
                    type: 'pre'
                });

                events.push({
                    hour: startHour,
                    label: `${formatTime(startHour)} - Intra-workout (Session ${sessionNum})`,
                    type: 'intra'
                });

                events.push({
                    hour: startHour + 1,
                    label: `${formatTime(startHour + 1)} - Post-workout (Session ${sessionNum})`,
                    type: 'post'
                });
            });

            // Normalize hours to 0-23 for sorting
            events.forEach(event => {
                if (event.hour >= 24) event.hour -= 24;
            });

            // Sort events by hour, considering circular time if needed
            events.sort((a, b) => a.hour - b.hour);

            // (Existing fraction definitions and assignment to events)

            // Add other meals
            const numOtherMeals = 3;
            const mealIntervals = activeHours / (numOtherMeals + 1);
            const otherMealTimes = [];
            let currentTime = wakeTime;
            for (let i = 0; i < numOtherMeals; i++) {
                currentTime += mealIntervals;
                let mealHour = Math.floor(currentTime) % 24;
                // Avoid overlap
                while (events.some(e => e.hour === mealHour)) {
                    currentTime += 1;
                    mealHour = Math.floor(currentTime) % 24;
                }
                otherMealTimes.push(mealHour);
            }

            // Generate HTML
            let html = '<ul class="list-none space-y-2">';
            events.forEach(event => {
                html += `<li class="p-2 bg-gray-50 rounded-md"><strong>${event.label}:</strong> Protein ${event.protein}g, Carbs ${event.carbs}g, Fats ${event.fats}g</li>`;
            });

            otherMealTimes.sort((a, b) => a - b);
            otherMealTimes.forEach((hour, index) => {
                html += `<li class="p-2 bg-gray-50 rounded-md"><strong>${formatTime(hour)} - Other Meal ${index + 1}:</strong> Protein ${otherProtein}g, Carbs ${otherCarbs}g, Fats ${otherFats}g</li>`;
            });
            html += '</ul>';

            partitioningDiv.innerHTML = html;

            // (Existing meal planner, results display, warnings)
        }
    </script>
</body>
</html>